# מה במאמר
נלמד במאמר את שיטות לעבודה מתקדמת עם קבצים. יכולת למצוא שדות ספציפיים בתוך שורות ספציפיות, מצא והחלף, השוואת קבצים ועוד.

## הפקודה `awk` - ביצוע פעולות על תבניות
הפקודה `awk` [^1] בנויה משני עיקרים:

1. אם מופיע בקובץ תבנית,
2. תבצע פעולה.

אולי זה נשמע פשוט ולא כל כך מיוחד, אבל נלמד את האפשרויות ונבין שיש לכלי הזה הרבה מאוד עוצמה, ויכולת ניתוח קבצים באופן יסודי. 

### הדפסת שדות ספציפיים משורות ספציפיות

עיקר הרעיון של `awk` הוא שדות. דהיינו, אני אקח פלט של למשל פקודות  `ls -l`. וכידוע הפקודה מדפיסה אות `d` בשורה של תיקייה, ומקף בשורה של קובץ. אני כעת חשוב לי לדעת את רמת ההרשאות של כל תיקייה הקיימת בתיקייה הנוכחית, אוכל לעשות זאת בצורה הבאה:

```bash
ls -la | awk '/^d/ { print $1, $9 }'
```

אני יסביר את זה:

כשאנו מקלידים `ls -l` אנו מקבלים את רשימת התיקיות כולל מידע על הרשאות. כך נראה הקלט והפלט של הפקודה `ls -l`:

```bash
ls -la
```

```bash
total 80
drwxr-xr-x  7 user group  4096 Jun  2 12:34 .
drwxr-xr-x  4 user group  4096 May  1 10:12 ..
-rw-r--r--  1 user group   220 Apr 10 08:20 .bash_logout
-rw-r--r--  1 user group  3771 Apr 10 08:20 .bashrc
drwxr-xr-x  3 user group  4096 Jun  2 12:34 .config
drwxr-xr-x  2 user group  4096 Jun  2 12:34 .local
drwxr-xr-x  2 user group  4096 Jun  2 12:34 Documents
drwxr-xr-x  2 user group  4096 Jun  2 12:34 Downloads
drwxr-xr-x  2 user group  4096 Jun  2 12:34 Music
-rw-r--r--  1 user group   807 Apr 10 08:20 .profile
-rw-r--r--  1 user group     0 Jun  2 12:34 .hiddenfile
-rw-r--r--  1 user group  1024 Jun  2 12:34 example.txt
```

לכל שורה ישנם תשעה שדות. כאשר כל שדה מוגדר כמחרוזת או מספרים שאינם כוללים רווח. במקרה ואנו נרצה להדפיס רק את שדה ההרשאות (הראשון שבכל שורה) ואת שם התיקייה (השדה התשיעי בכל שורה), נכתוב את הפקודה כך:

```bash
ls -la | awk '/^d/ { print $1, $9 }'
```

והתוצאה תהיה הדפסת ההרשאות (השדה הראשון בכל שורה) של כל תיקייה (השדה התשיעי) - ורק תיקייה ולא קובץ.

```bash
drwxr-xr-x .
drwxr-xr-x ..
drwxr-xr-x .config
drwxr-xr-x .local
drwxr-xr-x Documents
drwxr-xr-x Downloads
drwxr-xr-x Music
```

**הסבר הפקודה:**
   
1. לאחר שביקשנו לראות את כל התיקיות ברשימה מורחבת (`ls -la`),
2. אנו משרשרים את הפלט (רשימת התיקיות המפורטת) באמצעות pipeline `|` כקלט לפקודה `awk`.
3. אנו מציבים תבנית `/d^/`. דהיינו, כל תחילת שורה (מיוצג כסימן "העלאה בחזקה" `^`) שמתחילה ב-`d` - תבצע עליה את הפעולה הבאה:
4. תדפיס מהשורה שמצאת את התבנית שהוגדרה (תזכורת: שורה שמתחילה באות `d`) רק את השדה הראשון והשדה התשיעי `{ print $1, $9 }`.

עד כאן הפקודה עצמה. ניתן לשים לב שהאופי של תחביר הפקודה הוא חדש לנו. ולכן לוקח קצת זמן לקלוט את הפוינט. הפקודה עצמה היא שפת תכנות שלמה ויש לה עוד הרבה כלים, וזוהי רק הדגמה לאפשרות אחת.

## הפקודה `sed` - המרה, מחיקה, ועריכת תווים בקבצים
הפקודה `sed` נגזרת משמה `stream editor` עורך קבצים לסינון והמרת טקסט. בין השאר היא משמשת להחלפת תבניות. נסקור להלן את אופן המרה ומחיקה של תבניות.

### המרת תבנית
לדוגמה, יש לי קובץ המכיל פרטי משתמשים וכל ערך מופרד באמצעות נקודה. אני רוצה לשנות את הנקודה לפסיק. אוכל לעשות זאת באמצעות שימוש בפקודה `sed`. בדומה לפקודה `awk` גם הפקודה `sed` מקבלת תבנית ופעולה. במקרה הנוכחי אנו נכניס תבנית של פסיק, ותבנית של נקודה, ונאמר לו להחליף את הנקודה לפסיק.

נניח ויש לי קובץ בשם`Students_Linux` הכולל שם, משפחה, גיל, ומייל של הסטודנטים בקורס לינוקס, וכל ערך מופרד באמצעות נקודה. אני רוצה להפוך את הקובץ לפורמט csv, שכל ערך יהיה מופרד בפסיק. כך נראה הקובץ המקורי -  מופרד באמצעות נקודה:

```txt
Name.Family.Age.Email
Aaron.Gonzalez.19.aaron.gonzalez@example.com
Alexander.Allen.21.alexander.allen@example.com
Amanda.Mitchell.21.amanda.mitchell@example.com
Amanda.White.21.amanda.white@example.com
Andrew.Jackson.23.andrew.jackson@example.com
Anthony.Nguyen.22.anthony.nguyen@example.com
Ashley.Taylor.22.ashley.taylor@example.com
Benjamin.Scott.20.benjamin.scott@example.com
Brandon.Adams.21.brandon.adams@example.com
```

וכך ייראה התחביר הבסיסי של הפקודה להמרת הנקודות לפסיקים:

```bash
sed 's/./,/g' Students_Linux
```

ננתח את הפקודה:

1. לאחר הפקודה `sed` אנו מציבים תבנית.
2. התבנית בנויה מארבעה חלקים מופרדים באמצעות סלאש `/`.
3. האות `s` מציינת חיפוש - `search`, דהיינו חפש אחר תבנית - 
4. לאחר הסלאש הראשון מופיע התבנית שעל הפקודה למצוא `./`
5. לאחר הסלאש השני מופיע התו שעל הפקודה לכתוב `,/`,
6. האות `g` מציינת גלובלי, בכל הקובץ.

כך ייראה הקובץ לאחר ביצוע הפקודה:

```bash
Name,Family,Age,Email
Aaron,Gonzalez,19,aaron.gonzalez@example.com
Alexander,Allen,21,alexander.allen@example.com
Amanda,Mitchell,21,amanda.mitchell@example.com
Amanda,White,21,amanda.white@example.com
Andrew,Jackson,23,andrew.jackson@example.com
Anthony,Nguyen,22,anthony.nguyen@example.com
Ashley,Taylor,22,ashley.taylor@example.com
Benjamin,Scott,20,benjamin.scott@example.com
Brandon,Adams,21,brandon.adams@example.com
```

### מחיקת תבנית
אם יש לנו קובץ (או כל פלט שהוא) ואנו לא רוצים להציג שורות מסוימות, נוכל להשתמש בתבנית  `/d/`. לדוגמא יש לנו קובץ בשם `example.txt` ובו יש את השורות הבאות:

```txt
Hello World
Remove this line
This is a test
Remove this as well
Hello again
```

אני רוצה שלא להציג את השורות המתחילות במילה `Remove`, אוכל לעשות זאת עם הפקודה הבאה:

```bash
sed '/Remove/d' example.txt
```

כמו שאנחנו יודעים, 
1. לאחר `sed` מגיע התבנית,
2. במקרה הנוכחי למחוק `/d/` כל שורה שמתחילה ב-`Remove`.
3. הקיימים בקובץ `example.txt`.

## הפקודה `uniq` - מציאת כפילויות
הפקודה `uniq` משמשת למציאת ועיבוד שורות שכופלות את עצמן בקובץ או בפלט. לדוגמא אם יש לי קובץ שיש בו מספר שורות שכופלות את עצמן אוכל לקבל מידע כמה פעמים, או שאני יכול למחוק את השורות המיותרות ועוד. נראה כמה דוגמאות למחיקת שורות והצגת הכפילויות.

### מחיקת שורות כפולות סמוכות
יש לי קובץ עם רשימת מכולת, ובטעות רשמו שם כמה מבני הבית את אותם מוצרים כמה פעמים, (בטעות, כמובן...),

```txt
apple
bananas
milk
eggs
apple
beard
beard
yogurt
apples
apples
bananas
```

אני רוצה למחוק את המוצרים המיותרים. במקרה והמוצרים הכפולים כתובים בשני שורות סמוכות, אוכל לעשות זאת עם הפקודה הבאה:

```bash
uniq Grocery_list
```

הפקודה תמחק את המוצרים הכפולים הכתובים בשורות סמוכות. וכך זה ייראה לאחר ביצוע הפקודה:

```bash
apple
bananas
milk
eggs
apple
beard
yogurt
apples
bananas
```

### מחיקת שורות כפולות
נוכל לראות שעדיין נשארו לי מוצרים כפולים. נוכל למחוק אותם באמצעות האפשרות `u-` שתדפיס לי רק שורות ייחודיות - היינו לא כפולות:

```bash
uniq -u Grocery-list
```

```bash
apple
bananas
milk
eggs
beard
yogurt
```

### קבלת מספר הכפילויות
אם נרצה לקבל את רשימת המוצרים ואת מספר הכפילויות של כל פריט, נוסיף את האפשרות `c-`:

```bash
uniq -c Grocery-list
```

```bash
      2 apple
      2 bananas
      1 milk
      1 eggs
      2 beard
      1 yogurt
      2 apples
```

## הפקודה `comm` - השוואת קבצים
הפקודה `comm` משמשת להשוואת קבצים שורה אחר שורה, בתנאי שהשורות בקבצים ממוינים.

הפקודה לוקחת את שני הקבצים ופולטת שלושה רשימות (בתצורת עמודות): רשימה ובה הערכים שישנם רק בקובץ X, רשימה ובה הערכים הקיימים רק בקובץ Y, ורשימה שלישית הכוללת את הערכים הקיימים בשני הקבצים.

### קבלת הפלט המלא
לדוגמה, יש לי שני קבצים עם כמה פריטים - חלקם שונים, וחלקם משותפים. הקובץ הראשון נקרא לו `file_1` וזה הוא תוכנו:

```txt
apple
banana
cherry
date
```

והקובץ השני נקרא `file_2` וכך כתוב בו:

```txt
banana
date
fig
grape
```

כדי להשוות את הקבצים הנזכרים, `file_1` ואת `file_2` נוכל להשתמש בפקודה הבאה:

```bash
comm file_1 file_2
```

הפלט ייראה כך:

```bash
apple
		banana
cherry
		date
	fig
	grape
```

בפלט ישנם שלושה עמודות. בעמודה הראשונה מופיעים הפריטים שישנם אך ורק בקובץ `file_1`. בעמודה השנייה אך ורק הפריטים שישנם בקובץ `file_2`. ובעמודה השלישית את הפריטים שמופיעים בשני הקבצים.

### קבלת עמודות ספציפיות
נוכל לציין איזה עמודות **לא** לקבל בפלט על ידי הוספת מספר העמודה במינוס. לדוגמא אם אני רוצה לראות רק את העמודה השלישית שבה מופיעים הפריטים המשותפים לשני הקבצים אעשה זאת על ידי הוספת `12-`:

```bash
comm -12 file_1 file_2
```

וכן אם אני רוצה לראות את שני עמודות 1-2 אציין בפקודה `3-`

```bash
comm -3 file_1 file_2
```

# סיכום
למדנו במאמר זה מספר פקודות מתקדמות בעריכת קבצים ובעבודה שוטפת מול קבצים. הפקודה `awk` יכולה להדפיס שדות ספציפיים מעמודות ספציפיות, הפקודה `sed` יכולה להמיר תווים ומופעים שונים בקבצים, הפקודה `uniq` מוצאת ומעבדת כפילויות בקובץ, והפקודה `comm` משמשת להשוואת קבצים.

[^1]: השם `awk` מסמל את שלושת מפתחי הפקודה: Alfred Aho, Peter Weinberger, Brian Kernighan.
